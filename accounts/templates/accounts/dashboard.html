{% extends "projects/layout.html" %}
{% load static %}

{% block title %} Dashboard {% endblock %}

{% block main %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">

            <!-- Profile Card -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <div class="row align-items-center justify-content-between">
                                
                                <!-- User image handling -->
                                <div class="text-center">
                                    {% if profile.id == request.user.id %}
                                        <form id="photo-form" enctype="multipart/form-data">
                                            <label for="photo-upload" style="cursor: pointer;" title="Change profile photo">
                                                <img src="{% if profile.photo %}{{ profile.photo.url }}{% else %}{% static 'projects/default.png' %}{% endif %}"
                                                    alt="{{ profile.username }} photo" class="rounded-circle mb-2" id="profile-image"
                                                    style="width: 80px; height: 80px; object-fit: cover;">
                                            </label>
                                            <input type="file" name="photo" id="photo-upload" accept=".png, .jpeg, .jpg" style="display: none;">
                                        </form>
                                    {% else %}
                                        <img src="{% if profile.photo %}{{ profile.photo.url }}{% else %}{% static 'projects/default.png' %}{% endif %}"
                                            alt="{{ profile.username }} photo" class="rounded-circle mb-2"
                                            style="width: 80px; height: 80px; object-fit: cover;">
                                    {% endif %}
                                    <h4 class="fw-bold mb-0">{{ profile.username }}</h4>
                                </div>

                                <!-- User followers -->
                                <div class="text-center mb-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <h4 class="text-success mb-0" id="followers-count">{{ profile.followers }}
                                            </h4>
                                            <small class="text-muted">Followers</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-info mb-0">{{ profile.following }}</h4>
                                            <small class="text-muted">Following</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Follow Action -->
                                <div class="text-center">
                                    {% if profile.id != request.user.id %}
                                        <button class="btn {% if is_following %}btn-outline-danger{% else %}btn-primary{% endif %}" id="toggle_follow" data-user="{{ profile.id }}">
                                            <i class="bi bi-{% if is_following %}person-dash{% else %}person-plus{% endif %} me-1"></i>
                                            {% if is_following %}Unfollow{% else %}Follow{% endif %}
                                        </button>
                                    {% endif %}
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projects Table -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-0">
                    {% if projects %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0 fw-semibold text-muted">No.</th>
                                        <th class="border-0 fw-semibold text-muted">Project Name</th>
                                        <th class="border-0 fw-semibold text-muted">Views</th>
                                        <th class="border-0 fw-semibold text-muted">Stars</th>
                                        <th class="border-0 fw-semibold text-muted">Visibility</th>
                                        <th class="border-0 fw-semibold text-muted">Created</th>
                                        <th class="border-0 fw-semibold text-muted">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in projects %}
                                        <tr>
                                            <td class="align-middle">
                                                <span class="badge bg-light text-dark border">{{ forloop.revcounter }}</span>
                                            </td>
                                            <td class="align-middle">
                                                <h6 class="mb-0 fw-semibold project-title">{{ project.title }}</h6>
                                            </td>
                                            <td class="align-middle">
                                                <span class="badge bg-info">{{ project.viewers.count }}</span>
                                            </td>
                                            <td class="align-middle">
                                                <span class="badge bg-warning">{{ project.stars.count }}</span>
                                            </td>

                                            <!-- visibility display and aciton -->
                                            <td class="align-middle">
                                                {% if project.owner == user %}
                                                    <select name="visibility" data-id="{{ project.id }}" class="visibility-select badge bg-light text-black">
                                                        <option value="public" {% if project.is_public %}selected disabled{% endif %}>Public</option>
                                                        <option value="private" {% if not project.is_public %}selected disabled{% endif %}>Private</option>
                                                    </select>
                                                {% else %}
                                                    {% if project.is_public %}
                                                        <span class="badge bg-success">Public</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">Private</span>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            
                                            <td class="align-middle">
                                                <small class="text-muted">{{ project.timestamp|date:"M d, Y" }}</small>
                                            </td>
                                            <td class="align-middle">
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'projects:detail' project.id %}"
                                                        class="btn btn-sm btn-outline-primary" title="View Project">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    {% if user == project.owner %}
                                                        <a href="{% url 'projects:update' project.id %}"
                                                            class="btn btn-sm btn-outline-warning" title="Edit Project">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                        <button class="btn btn-sm btn-outline-danger delete-btn"
                                                            data-id="{{ project.id }}" title="Delete Project">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <h4 class="text-muted">No Projects Yet</h4>
                        </div>
                    {% endif %}
                </div>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}