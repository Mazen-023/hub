{% extends "projects/layout.html" %}
{% load static %}

{% block title %} Dashboard {% endblock %}

{% block main %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <!-- Profile Card -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <div class="row align-items-center justify-content-between">
                                <div class="text-center">
                                    {% if profile.photo %}
                                        <img src="{{ profile.photo.url }}" alt="{{ profile.username }} photo" class="rounded-circle mb-2"
                                            style="width: 80px; height: 80px; object-fit: cover;">
                                    {% else %}
                                        <img src="{% static 'projects/default.png' %}" alt="default image" class="rounded-circle mb-2"
                                            style="width: 80px; height: 80px; object-fit: cover;">
                                    {% endif %}
                                    <h4 class="fw-bold mb-0">{{ profile.username }}</h4>
                                </div>
                                <div class="text-center mb-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <h4 class="text-success mb-0" id="followers-count">{{ profile.followers }}
                                            </h4>
                                            <small class="text-muted">Followers</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-info mb-0">{{ profile.following }}</h4>
                                            <small class="text-muted">Following</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    {% if profile.id != request.user.id %}
                                        <button class="btn btn-primary" id="toggle_follow" data-user="{{ profile.id }}">
                                            <i class="bi bi-{% if is_following %}person-dash{% else %}person-plus{% endif %} me-1"></i>
                                            {% if is_following %}Unfollow{% else %}Follow{% endif %}
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projects Table -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-0">
                    {% if projects %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0 fw-semibold text-muted">No.</th>
                                        <th class="border-0 fw-semibold text-muted">Project Name</th>
                                        <th class="border-0 fw-semibold text-muted">Views</th>
                                        <th class="border-0 fw-semibold text-muted">Stars</th>
                                        <th class="border-0 fw-semibold text-muted">Visibility</th>
                                        <th class="border-0 fw-semibold text-muted">Created</th>
                                        <th class="border-0 fw-semibold text-muted">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in projects %}
                                        <tr>
                                            <td class="align-middle">
                                                <span class="badge bg-light text-dark border">{{ forloop.revcounter }}</span>
                                            </td>
                                            <td class="align-middle">
                                                <h6 class="mb-0 fw-semibold project-title">{{ project.title }}</h6>
                                            </td>
                                            <td class="align-middle">
                                                <span class="badge bg-info">{{ project.viewers.count }}</span>
                                            </td>
                                            <td class="align-middle">
                                                <span class="badge bg-warning">{{ project.stars.count }}</span>
                                            </td>
                                            <td class="align-middle">
                                                {% if project.is_public %}
                                                    <span class="badge bg-success">Public</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Private</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <small class="text-muted">{{ project.timestamp|date:"M d, Y" }}</small>
                                            </td>
                                            <td class="align-middle">
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'projects:project_detail' project.id %}"
                                                        class="btn btn-sm btn-outline-primary" title="View Project">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    {% if user == project.owner %}
                                                        <a href="{% url 'projects:update' project.id %}"
                                                            class="btn btn-sm btn-outline-warning" title="Edit Project">
                                                            <i class="bi bi-pencil"></i>
                                                        </a>
                                                        <button class="btn btn-sm btn-outline-danger delete-btn"
                                                            data-id="{{ project.id }}" title="Delete Project">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <h4 class="text-muted">No Projects Yet</h4>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        delete_project();
        toggle_follow();
    });

    function delete_project() {
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();
                const projectId = this.dataset.id;
                const projectRow = this.closest('tr');
                const projectTitle = projectRow.querySelector('.project-title').textContent;

                if (confirm(`Are you sure you want to delete "${projectTitle}"? This action cannot be undone.`)) {
                    // Add loading state
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    this.disabled = true;

                    fetch(`/delete/${projectId}/`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (response.ok) {
                            // Fade out and remove the row
                            projectRow.style.transition = 'opacity 0.3s ease';
                            projectRow.style.opacity = '0';
                            setTimeout(() => {
                                projectRow.remove();
                                // Update project count
                                const badge = document.querySelector('.card-header .badge');
                                if (badge) {
                                    const currentCount = parseInt(badge.textContent.split(' ')[0]);
                                    badge.textContent = `${currentCount - 1} total`;
                                }
                            }, 300);
                        } else {
                            alert('Something went wrong. Please try again.');
                            // Reset button
                            this.innerHTML = '<i class="bi bi-trash"></i>';
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please check the console.');
                        // Reset button
                        this.innerHTML = '<i class="bi bi-trash"></i>';
                        this.disabled = false;
                    });
                }
            });
        });
    }

    function toggle_follow() {
        const btn = document.getElementById('toggle_follow');
        if (!btn) return;

        btn.addEventListener('click', function (event) {
            event.preventDefault();
            const userId = this.dataset.user;
            const originalText = this.innerHTML;

            // Add loading state
            this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Loading...';
            this.disabled = true;

            fetch(`/follow/${userId}/`, { 
                method: 'POST' 
            })
            .then(response => response.json())
            .then(result => {
                const followerCount = document.getElementById('followers-count');

                if (result.message === 'Followed') {
                    if (followerCount) followerCount.textContent = result.followers;
                    this.innerHTML = '<i class="bi bi-person-dash me-2"></i>Unfollow';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-outline-danger');
                } else if (result.message === 'Unfollowed') {
                    if (followerCount) followerCount.textContent = result.followers;
                    this.innerHTML = '<i class="bi bi-person-plus me-2"></i>Follow';
                    this.classList.remove('btn-outline-danger');
                    this.classList.add('btn-primary');
                } else if (result.message) {
                    alert(result.message);
                    this.innerHTML = originalText;
                }

                this.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                this.innerHTML = originalText;
                this.disabled = false;
                alert('An error occurred. Please try again.');
            });
        });
    }
</script>
{% endblock %}